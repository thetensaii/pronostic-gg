name: "CD Pipeline"

on: 
  workflow_dispatch:
  workflow_run:
    workflows: [CI Pipeline]
    types: [completed]
    branches: [main]

env:
  # DB
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PORT: ${{ secrets.DB_PORT }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_DATABASE: ${{ secrets.DB_DATABASE }}

  # BACKEND
  NODE_ENV: not-used
  APP_KEY: not-used
  TZ: not-used
  PORT: not-used
  HOST: 0.0.0.0
  SESSION_DRIVER: not-used
  LOG_LEVEL: not-used
  LOG_FILE_PATH: not-used
  PUBLIC_FRONT_URL: not-used
  PUBLIC_BACKEND_URL: not-used
  GOOGLE_CLIENT_ID: not-used
  GOOGLE_CLIENT_SECRET: not-used


jobs:
  deploy:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install PNPM 8.15
      uses: pnpm/action-setup@v4
      with:
        version: 8.15

    - name: Install Node 20.11
      uses: actions/setup-node@v4
      with:
        node-version: 20.11
        cache: 'pnpm'

    - name: Install Project
      run: pnpm install
    
    - name: Run DB Migrations
      run: pnpm run db:migrations:run:force

